import{_ as e}from"./plugin-vue_export-helper-x3n3nnut.js";import{o as p,c as o,d as t}from"./app-AuAuVshg.js";const c="data:image/png;base64,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",n="/assets/注册中心2-UJMBejQ9.png",l="/assets/注册中心3-saXQPPAa.png",r="/assets/注册中心4-gUgnRF3c.png",s="/assets/注册中心5-DaeePOdt.png",d="/assets/注册中心6-xJExTtHQ.png",g="/assets/注册中心7-XHfWEmvY.png",m="/assets/注册中心8-LRHYkPrs.png",u="data:image/png;base64,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",i="/assets/注册中心10-mSOuVxzw.png",f="/assets/注册中心12-Vhci-STs.png",A="/assets/注册中心13-WnfEdyt8.png",a="/assets/注册中心15-29CE0xMP.png",h={},k=t('<p>不管是出于面试，还是深入学习注册中心，关于如何设计一个注册中心都是一个很好的话题。</p><p>假设现在我们系统有两个小系统：</p><ul><li>订单系统</li><li>商品系统</li></ul><p>单个系统分别部署在不同服务器上，如果我们订单系统需要调用商品系统的某个服务：</p><figure><img src="'+c+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h2 id="怎么调用" tabindex="-1"><a class="header-anchor" href="#怎么调用" aria-hidden="true">#</a> 怎么调用？</h2><p>方法1：商品系统开发的朋友告诉你对应的地址。</p><figure><img src="'+n+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>方法2：商品系统开发的朋友把对应<code>API</code>地址存放到某个地方。</p><figure><img src="'+l+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>方法3：直接通过Nginx，使用域名进行转发到某个实例上。</p><figure><img src="'+r+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>这时候，订单系统就可以通过上述方法调用商品系统的<code>API</code>了。</p><h2 id="问题来了" tabindex="-1"><a class="header-anchor" href="#问题来了" aria-hidden="true">#</a> 问题来了</h2><p>实际线上环境中，很少是单体机构的，很多都是做了集群的，也就是说每个服务会有N个实例，少则几个几十个，多则几百上千上万。如果此时我们还用上面三种方法，当我们的商品系统某个服务下线（宕机了），或者新增实例，此时是非常的头疼。</p><blockquote><p>所以，注册中心就来了。</p></blockquote><h2 id="注册中心来了" tabindex="-1"><a class="header-anchor" href="#注册中心来了" aria-hidden="true">#</a> 注册中心来了</h2><p>我们能不能搞一个第三方的节点，这个节点就用来存放我们商品系统的服务信息，这样一来，其他系统需要服务信息，直接去第三方节点上去获取即可。此时，其他系统只要知道这个第三方的节点地址就可以了。这个第三方的节点，我们也称之为<code>注册中心</code>。</p><blockquote><p>下面我们用服务提供方（商品系统）称之为provider，服务调用方（订单系统）我们称之为consumer。</p></blockquote><h2 id="如何设计一个注册中心" tabindex="-1"><a class="header-anchor" href="#如何设计一个注册中心" aria-hidden="true">#</a> 如何设计一个注册中心</h2><p>我们需要解决如下几个问题：</p><ul><li>服务如何注册</li><li>consumer如何知道provider</li><li>服务注册中心如何高可用</li><li>服务上下线，消费端如何动态感知</li></ul><h3 id="服务注册" tabindex="-1"><a class="header-anchor" href="#服务注册" aria-hidden="true">#</a> 服务注册</h3><figure><img src="'+s+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>当我们把服务信息注册上去后，就应该是：</p><figure><img src="'+d+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><blockquote><p>服务列表保存通常有三种方式：本地内存、数据库、第三方缓存系统</p></blockquote><p>注册上去后，consumer需要服务地址的时候，就可以用相应key去注册中心获取对应的服务列表。</p><figure><img src="'+g+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><blockquote><p>同一个服务注册中心，我们可以注册多个服务，比如用户服务、商品服务、订单服务...</p></blockquote><h3 id="服务消费" tabindex="-1"><a class="header-anchor" href="#服务消费" aria-hidden="true">#</a> 服务消费</h3><figure><img src="'+m+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>consumer端通过key获取指定的服务地址列表。</p><p>以上的还是蛮简单的吧，简单来说，我们就是引用了一个第三方的服务来存放我们的服务提供者列表。并且以key-value的形式存储，key我们可以理解为服务名称，value就是服务实例列表。</p><figure><img src="'+u+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h3 id="注册中心高可用" tabindex="-1"><a class="header-anchor" href="#注册中心高可用" aria-hidden="true">#</a> 注册中心高可用</h3><p>高可用无非就是做集群，我们可以对注册中心部署多个节点。在消费端consumer只需要知道一个服务注册中心集群地址<code>cluster-url</code>即可。</p><figure><img src="'+i+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><h3 id="动态感知服务上下线" tabindex="-1"><a class="header-anchor" href="#动态感知服务上下线" aria-hidden="true">#</a> 动态感知服务上下线</h3><p>consumer拿到服务列表后，会把服务列表保存起来，保存到本地缓存里。</p><figure><img src="'+i+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>consumer通过一定的负载均衡算法，选择出一个地址，最后发起远程的调用。</p><figure><img src="'+f+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>如果我们的服务节点挂掉一个了，怎么办？</p><figure><img src="'+A+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>此时，服务注册中心的服务列表还是之前的列表，如果consumer调用到挂掉的节点上，那岂不是会出问题呀。</p><p>所以，我们的服务注册中心需要知道哪个服务节点挂了，然后从对应服务列表里删除。</p><p>有种办法叫做心跳检测<code>heartBeat</code>，即就是服务注册中心，每隔一定时间去检测一下provider，如果检测到某个服务挂了，那就把对应服务地址从服务列表中删除。</p><blockquote><p>根据心跳检测，来剔除无效服务。</p></blockquote><figure><img src="'+A+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>可是不对呀，此时consumer端本地列表里还有过掉的服务地址，怎么办呢？</p><p>或者是，在增加一个新的服务节点</p><figure><img src="'+a+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>对于服务注册中心来说，就是服务列表里增加一个服务地址。</p><p>但是在消费端存在同样的问题，就是服务注册中心的服务列表和consumer端的服务列表不一样了。</p><p>如何让consumer端也动态感知呢？</p><p>其实很简单，此时，我们得思维换一下，因为consumer的服务列表是来自于服务注册中心，我们就可以把consumer理解为消费端，服务注册中心理解为服务端。此时，consumer端就可以去服务端（服务注册中心）拉取provider服务列表。</p><p>通常有两种方案：push和pull</p><ul><li>push：服务注册中心主动推送服务列表给consumer。</li><li>pull：consumer主动从注册中心拉取服务列表。</li></ul><figure><img src="'+a+'" alt="img" tabindex="0" loading="lazy"><figcaption>img</figcaption></figure><p>不管是push还是pull，都会存在consumer和服务注册中心的通信管道。如果他们之间断开了，那就无法获取服务列表了。</p><p>还有就是服务注册中心知道consumer的地址，比如</p><blockquote><p>我得知道你的微信好友，不然我怎么把我手里的资源发给你</p></blockquote><p>我们的网络通信，必然会存在监听的动作。</p><p>如果服务注册中心要push到consumer，此时他们之间需要建立一个会话，所以，在服务注册中心会维护一个会话管理的模块。还有一种方式就是consumer提供一个<code>API</code>，这个<code>API</code>给服务注册中心进行回调。</p><blockquote><p>本质是我们是使用HTTP协议还是使用Socket监听</p></blockquote><p>push有个不好点，那就是服务注册中心需要维护大量的会话，而且还需要对每个会话维持一个心跳，以便知晓这些会话状态，得确保这些consumer能收到数据，</p><p>另外就是pull，pull其实就相对push就简单多了。pull和我们前面说的心跳机制是类似的，consumer端启动定时任务，每隔多久拉取服务注册中心的服务列表。pull也不需要去维护大量的会话，我只需要每隔多久调用接口拉取服务列表即可。但是这里还是会存在一个问题，因为是定时去拉取，所以会存在一定的数据延迟，比如consumer刚刚拉取服务列表，但就在拉取结束的后，某个服务provider挂了，consumer就要等下次拉取才知道对应服务provider挂了。</p><blockquote><p>如果定时任务是每隔30秒拉去一次，那就是说，延迟最长时间是30秒。</p></blockquote><p>还有一种方式long-pull，也叫长轮询，是上面两种方案的优化方案，consumer发起拉取请求时，先把这个请求hold住，当服务注册中心有发生变化后，consumer端能立马感知。</p><p>关于长轮询：</p><blockquote><p>与简单轮询相似，只是在服务端在没有新的返回数据情况下不会立即响应，而会挂起，直到有数据或即将超时</p><p><code>优点</code>：实现也不复杂，同时相对轮询，节约带宽</p><p><code>缺点</code>：还是存在占用服务端资源的问题，虽然及时性比轮询要高，但是会在没有数据的时候在服务端挂起，所以会一直占用服务端资源，处理能力变少</p><p><code>应用</code>：一些早期的对及时性有一些要求的应用：web IM 聊天</p></blockquote><p>这样，我们就搞定了所谓的服务上下线动态感知。</p><p>通过上面的服务注册、服务消费、注册中心高可用以及动态感知服务的上下线，这就是我们去实现一个服务注册中心的通用模型。</p><h3 id="小总结" tabindex="-1"><a class="header-anchor" href="#小总结" aria-hidden="true">#</a> 小总结</h3><p>关于如何设计一个注册中心，无非重点关以下几点：</p><ul><li>服务是如何注册</li><li>消费端如何获取服务</li><li>如何保证注册中心的高可用</li><li>动态感知服务的上下线</li></ul>',77),S=[k];function J(x,R){return p(),o("div",null,S)}const E=e(h,[["render",J],["__file","如何设计一个注册中心.html.vue"]]);export{E as default};
